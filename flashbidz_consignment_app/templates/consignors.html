{% include "_navbar.html" %}

{% macro sort_icon(column) %}
    {% if sort_by == column %}
        {% if sort_dir == 'asc' %}
            ▲
        {% else %}
            ▼
        {% endif %}
    {% else %}
        ▾
    {% endif %}
{% endmacro %}

<main class="page">
    <div class="actions-bar">
        <h1>Consignors</h1>
        <a class="btn" href="{{ url_for('consignor_create') }}">+ New Consignor</a>

        <!-- Search Bar -->
        <form method="get"
              action="{{ url_for('consignors_list') }}"
              class="search-form"
              style="margin-top: 10px;">
            
            <input type="text"
                   name="q"
                   placeholder="Search by name, email, or phone"
                   value="{{ search or '' }}"
                   style="padding: 4px; width: 250px;">

            <button type="submit" style="padding: 4px 10px;">Search</button>

            {% if search %}
                <a href="{{ url_for('consignors_list') }}" style="margin-left: 10px;">Clear</a>
            {% endif %}
        </form>
        <!-- End Search Bar -->

    </div>

    {% if consignors %}
        <table>
            <thead>
  <tr>
    <th>
      <a href="?search={{ search }}&sort_by=name&sort_dir={{ 'desc' if sort_by == 'name' and sort_dir == 'asc' else 'asc' }}">
        Name {{ sort_icon('name') }}
      </a>
    </th>
    <th>
      <a href="?search={{ search }}&sort_by=email&sort_dir={{ 'desc' if sort_by == 'email' and sort_dir == 'asc' else 'asc' }}">
        Email {{ sort_icon('email') }}
      </a>
    </th>
    <th>
      <a href="?search={{ search }}&sort_by=phone&sort_dir={{ 'desc' if sort_by == 'phone' and sort_dir == 'asc' else 'asc' }}">
        Phone {{ sort_icon('phone') }}
      </a>
    </th>
    <th>
      <a href="?search={{ search }}&sort_by=commission_pct&sort_dir={{ 'desc' if sort_by == 'commission_pct' and sort_dir == 'asc' else 'asc' }}">
        Commission % {{ sort_icon('commission_pct') }}
      </a>
    </th>
    <th>
      <a href="?search={{ search }}&sort_by=advance_balance&sort_dir={{ 'desc' if sort_by == 'advance_balance' and sort_dir == 'asc' else 'asc' }}">
        Advance Balance ($) {{ sort_icon('advance_balance') }}
      </a>
    </th>

    <!-- Non-sortable columns stay the same -->
    <th>DL</th>
    <th>Actions</th>
  </tr>
</thead>

      <tbody>
        {% for c in consignors %}
          <tr>
            <td>{{ c.name }}</td>
            <td>{{ c.email }}</td>
            <td>{{ c.phone }}</td>
            <td>{{ "%.2f"|format(c.commission_pct or 0) }}</td>
            <td>{{ "%.2f"|format(c.advance_balance or 0) }}</td>
            <td>
                {% if c.license_image %}
                    <img src="/uploads/licenses/{{ c.license_image }}"
                         alt="DL"
                         style="width:40px;height:auto;border-radius:4px;border:1px solid #ccc;">
                {% else %}
                    <span style="color:#aaa;">None</span>
                {% endif %}
            </td>


            <td>
              <a class="edit-link" href="{{ url_for('consignors_edit', cid=c.id) }}">Edit</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>No consignors yet.</p>
  {% endif %}
</main>
