{% include "_navbar.html" %}

{% macro sort_icon(column) %}
    {% if sort_by == column %}
        {% if sort_dir == 'asc' %}
            ▲
        {% else %}
            ▼
        {% endif %}
    {% else %}
        ▾
    {% endif %}
{% endmacro %}

<main class="page">
    <div class="actions-bar">
      <h1>Consignors</h1>
      <a class="btn" href="{{ url_for('consignor_create') }}">+ New Consignor</a>
    <a class="btn"
       href="{{ url_for(
                'export_consignors',
                q=search,
                missing_dl='1' if missing_dl else '',
                sort_by=sort_by,
                sort_dir=sort_dir
             ) }}"
       style="margin-left: 10px;
              background-color: #007BFF;
              color: white;
              padding: 6px 10px;
              border-radius: 4px;">
      Export current results (CSV)
    </a>

      <a class="btn"
         href="{{ url_for(
                  'export_consignors',
                  q=search,
                  missing_dl='1' if missing_dl else '',
                  sort_by=sort_by,
                  sort_dir=sort_dir
               ) }}"
         style="margin-left: 10px; background-color: #4a4a4a;">
        Export current results (CSV)
      </a>
    </div>

        <!-- Search Bar -->
       <form method="get"
      action="{{ url_for('consignors_list') }}"
      class="search-form"
      style="margin-top: 10px;">

  <input type="text"
         name="q"
         placeholder="Search by name, email, or phone"
         value="{{ search or '' }}"
         style="padding: 4px; width: 250px;">

  <label style="margin-left: 10px; font-size: 0.9em;">
    <input type="checkbox"
           name="missing_dl"
           value="1"
           {% if missing_dl %}checked{% endif %}>
    Only show missing DL
  </label>

  <button type="submit" style="padding: 4px 10px;">Search</button>

  <a href="{{ url_for('consignors_list') }}" style="margin-left: 10px;">Clear</a>
</form>

        <!-- End Search Bar -->

    </div>

    {% if consignors %}
        <table>
            <thead>
  <tr>
    <th>
      <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by=name&sort_dir={{ 'desc' if sort_by == 'name' and sort_dir == 'asc' else 'asc' }}">
        Name {{ sort_icon('name') }}
      </a>
    </th>

    <th>
      <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by=email&sort_dir={{ 'desc' if sort_by == 'email' and sort_dir == 'asc' else 'asc' }}">
        Email {{ sort_icon('email') }}
      </a>
    </th>

    <th>
      <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by=phone&sort_dir={{ 'desc' if sort_by == 'phone' and sort_dir == 'asc' else 'asc' }}">
        Phone {{ sort_icon('phone') }}
      </a>
    </th>

    <th>
      <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by=commission_pct&sort_dir={{ 'desc' if sort_by == 'commission_pct' and sort_dir == 'asc' else 'asc' }}">
        Commission % {{ sort_icon('commission_pct') }}
      </a>
    </th>

    <th>
      <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by=advance_balance&sort_dir={{ 'desc' if sort_by == 'advance_balance' and sort_dir == 'asc' else 'asc' }}">
        Advance Balance ($) {{ sort_icon('advance_balance') }}
      </a>
    </th>

    <!-- Leave these non-sortable -->
    <th>DL</th>
    <th>Actions</th>
  </tr>
</thead>


      <tbody>
        {% for c in consignors %}
          <tr>
            <td>{{ c.name }}</td>
            <td>{{ c.email }}</td>
            <td>{{ c.phone }}</td>
            <td>{{ "%.2f"|format(c.commission_pct or 0) }}</td>
            <td>{{ "%.2f"|format(c.advance_balance or 0) }}</td>
            <td>
                {% if c.license_image %}
                    <img src="/uploads/licenses/{{ c.license_image }}"
                         alt="DL"
                         style="width:40px;height:auto;border-radius:4px;border:1px solid #ccc;">
                {% else %}
                    <span style="color:#aaa;">None</span>
                {% endif %}
            </td>


            <td>
              <a class="edit-link" href="{{ url_for('consignors_edit', cid=c.id) }}">Edit</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <!-- Pagination summary -->
    <div style="margin-top: 10px; font-size: 13px; color: #555;">
        Showing {{ start_index }}–{{ end_index }} of {{ total }} consignors
    </div>

    <!-- Pagination controls -->
    {% if total_pages > 1 %}
    <div style="margin-top: 6px; font-size: 13px;">
        {% if page > 1 %}
            <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&page={{ page - 1 }}"
               style="margin-right: 6px;">« Prev</a>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
                <span style="margin: 0 3px; font-weight: bold;">{{ p }}</span>
            {% else %}
                <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&page={{ p }}"
                   style="margin: 0 3px;">{{ p }}</a>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
            <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&page={{ page + 1 }}"
               style="margin-left: 6px;">Next »</a>
        {% endif %}
    </div>
    {% endif %}
  {% else %}
    <p>No consignors yet.</p>
  {% endif %}
</main>
