{% include "_navbar.html" %}

{% macro sort_icon(column) %}
    {% if sort_by == column %}
        {% if sort_dir == 'asc' %}
            ▲
        {% else %}
            ▼
        {% endif %}
    {% else %}
        ▾
    {% endif %}
{% endmacro %}

<main class="page">
    <div class="actions-bar">
      <h1>Consignors</h1>
      <a class="btn" href="{{ url_for('consignor_create') }}">+ New Consignor</a>
    <a class="btn"
   href="{{ url_for(
            'export_consignors',
            q=search,
            missing_dl='1' if missing_dl else '',
            sort_by=sort_by,
            sort_dir=sort_dir
         ) }}"
   style="margin-left: 10px;
          background-color: #e60000;
          color: white;
          padding: 6px 12px;
          border-radius: 4px;
          font-weight: bold;
          border: none;">
  Export Current Results (CSV)
</a>
{% if missing_dl %}
    <a class="btn"
       href="{{ url_for(
                'consignors_list',
                search=search,
                sort_by=sort_by,
                sort_dir=sort_dir
            ) }}"
       style="margin-left: 10px;
              background-color: #000000;
              color: white;
              padding: 6px 12px;
              border-radius: 4px;
              border: 2px solid #e60000;
              font-weight: bold;">
        Show All Consignors
    </a>
{% else %}
    <a class="btn"
       href="{{ url_for(
                'consignors_list',
                search=search,
                missing_dl='1',
                sort_by=sort_by,
                sort_dir=sort_dir
            ) }}"
       style="margin-left: 10px;
              background-color: #e60000;
              color: white;
              padding: 6px 12px;
              border-radius: 4px;
              font-weight: bold;">
        Show Only Missing DL
    </a>
{% endif %}

    </div>
  {% if summary %}
  <div style="display:flex; flex-wrap:wrap; gap:16px; margin:12px 0 20px 0;">

    <div style="background:#000; color:#fff; padding:10px 14px;
                border-left:4px solid #e00000; border-radius:6px; min-width:180px;">
      <div style="font-size:12px; opacity:0.8;">Total Consignors</div>
      <div style="font-size:22px; font-weight:bold;">
        {{ summary.total_consignors }}
      </div>
    </div>

    <div style="background:#000; color:#fff; padding:10px 14px;
                border-left:4px solid #e00000; border-radius:6px; min-width:180px;">
      <div style="font-size:12px; opacity:0.8;">Missing License on File</div>
      <div style="font-size:22px; font-weight:bold;">
        {{ summary.missing_dl }}
      </div>
    </div>

    <div style="background:#000; color:#fff; padding:10px 14px;
                border-left:4px solid #e00000; border-radius:6px; min-width:220px;">
      <div style="font-size:12px; opacity:0.8;">Total Advance Balance</div>
      <div style="font-size:22px; font-weight:bold;">
        ${{ "%.2f"|format(summary.total_advance) }}
      </div>
    </div>

  </div>
  {% endif %}

        <!-- Search Bar -->
       <form method="get"
      action="{{ url_for('consignors_list') }}"
      class="search-form"
      style="margin-top: 10px;">

  <input type="text"
         name="q"
         placeholder="Search by name, email, or phone"
         value="{{ search or '' }}"
         style="padding: 4px; width: 250px;">

  <label style="margin-left: 10px; font-size: 0.9em;">
    <input type="checkbox"
           name="missing_dl"
           value="1"
           {% if missing_dl %}checked{% endif %}>
    Only show missing DL
  </label>

  <button type="submit" style="padding: 4px 10px;">Search</button>

  <a href="{{ url_for('consignors_list') }}" style="margin-left: 10px;">Clear</a>
</form>

        <!-- End Search Bar -->

    </div>

    {% if consignors %}
        <table>
            <thead>
  <tr>
    <th>
      <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by=name&sort_dir={{ 'desc' if sort_by == 'name' and sort_dir == 'asc' else 'asc' }}">
        Name {{ sort_icon('name') }}
      </a>
    </th>

    <th>
      <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by=email&sort_dir={{ 'desc' if sort_by == 'email' and sort_dir == 'asc' else 'asc' }}">
        Email {{ sort_icon('email') }}
      </a>
    </th>

    <th>
      <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by=phone&sort_dir={{ 'desc' if sort_by == 'phone' and sort_dir == 'asc' else 'asc' }}">
        Phone {{ sort_icon('phone') }}
      </a>
    </th>

    <th>
      <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by=commission_pct&sort_dir={{ 'desc' if sort_by == 'commission_pct' and sort_dir == 'asc' else 'asc' }}">
        Commission % {{ sort_icon('commission_pct') }}
      </a>
    </th>

    <th>
      <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by=advance_balance&sort_dir={{ 'desc' if sort_by == 'advance_balance' and sort_dir == 'asc' else 'asc' }}">
        Advance Balance ($) {{ sort_icon('advance_balance') }}
      </a>
    </th>

    <!-- Leave these non-sortable -->
    <th>DL</th>
    <th>Actions</th>
  </tr>
</thead>


 <tbody>
  {% for c in consignors %}
    <tr>
      <!-- NAME: link to consignor detail -->
      <td>
        <a href="{{ url_for('consignor_detail', consignor_id=c.id) }}">
          {{ c.name }}
        </a>
      </td>

      <!-- EMAIL -->
      <td>{{ c.email or "-" }}</td>

      <!-- PHONE -->
      <td>{{ c.phone or "-" }}</td>

      <!-- COMMISSION % -->
      <td>
        {{ "%.2f"|format(c.commission_pct or 0) }}%
      </td>

      <!-- ADVANCE BALANCE -->
      <td>
        ${{ "%.2f"|format(c.advance_balance or 0) }}
      </td>

      <!-- DL THUMBNAIL (whatever you already had here) -->
      <td>
        {% if c.license_image %}
          <img src="/static/uploads/licenses/{{ c.license_image }}"
               alt="DL"
               style="height:32px; width:auto; border-radius:3px;">
        {% else %}
          <span style="color:#e60000; font-weight:bold;">No DL</span>
        {% endif %}
      </td>
    </tr>
  {% endfor %}
</tbody>

    </table>
    <!-- Pagination summary -->
    <div style="margin-top: 10px; font-size: 13px; color: #555;">
        Showing {{ start_index }}–{{ end_index }} of {{ total }} consignors
    </div>

    <!-- Pagination controls -->
    {% if total_pages > 1 %}
    <div style="margin-top: 6px; font-size: 13px;">
        {% if page > 1 %}
            <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&page={{ page - 1 }}"
               style="margin-right: 6px;">« Prev</a>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
                <span style="margin: 0 3px; font-weight: bold;">{{ p }}</span>
            {% else %}
                <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&page={{ p }}"
                   style="margin: 0 3px;">{{ p }}</a>
            {% endif %}
        {% endfor %}

        {% if page < total_pages %}
            <a href="?search={{ search }}&missing_dl={{ '1' if missing_dl else '' }}&sort_by={{ sort_by }}&sort_dir={{ sort_dir }}&page={{ page + 1 }}"
               style="margin-left: 6px;">Next »</a>
        {% endif %}
    </div>
    {% endif %}
  {% else %}
    <p>No consignors yet.</p>
  {% endif %}
</main>
