{% extends "base.html" %}

{% block title %}Checkout – FlashBidz{% endblock %}

{% block content %}

<style>
  .checkout-wrap {
    max-width: 1100px;
    margin: 0 auto;
  }
  .checkout-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
  }
  .checkout-header h1 {
    font-size: 32px;
    margin: 0;
  }
  .checkout-scan-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 16px;
  }
  .checkout-scan-row input[type="text"] {
    flex: 1;
    min-width: 220px;
    font-size: 24px;
    padding: 10px 12px;
  }
  .checkout-scan-row button {
    font-size: 20px;
    padding: 10px 18px;
  }
  .checkout-actions-row {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 16px;
  }
  .checkout-actions-row form {
    display: inline-block;
  }
  .checkout-actions-row button {
    font-size: 18px;
    padding: 8px 14px;
  }
  .checkout-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 16px;
    font-size: 18px;
  }
  .checkout-table th,
  .checkout-table td {
    border-bottom: 1px solid #eee;
    padding: 8px;
    text-align: left;
  }
  .checkout-table th {
    background: #f5f5f5;
  }
  .checkout-summary {
    display: flex;
    flex-wrap: wrap;
    gap: 24px;
    align-items: center;
    justify-content: space-between;
  }
  .summary-totals {
    font-size: 20px;
  }
  .summary-totals div {
    margin-bottom: 4px;
  }
  .discount-form input[type="number"] {
    font-size: 20px;
    padding: 4px 8px;
    width: 140px;
  }
  .discount-form button {
    font-size: 18px;
    padding: 6px 12px;
  }

  /* iPad / kiosk tweaks */
  @media (max-width: 900px) {
    .checkout-header h1 {
      font-size: 26px;
    }
    .checkout-table {
      font-size: 16px;
    }
    .checkout-scan-row input[type="text"] {
      font-size: 20px;
    }
    .checkout-scan-row button {
      font-size: 18px;
    }
  }
</style>

<div class="checkout-wrap">
  <div id="checkout-beep" data-beep="{{ beep or '' }}" style="display:none;"></div>

  <div class="checkout-header">
    <h1>Quick Checkout</h1>
    <div>
      <div>Today: {{ today.strftime("%Y-%m-%d") }}</div>
    </div>
  </div>

  <!-- SCAN BAR -->
  <form method="post" action="{{ url_for('checkout_scan') }}" class="checkout-scan-row">
    <input type="text"
           name="sku"
           placeholder="Scan or type SKU…"
           autofocus
           autocomplete="off"
           inputmode="numeric">
    <button type="submit" class="btn btn-primary">Scan / Add</button>
  </form>

  <!-- ACTION BUTTONS: UNDO, CLEAR -->
  <div class="checkout-actions-row">
    <form method="post" action="{{ url_for('checkout_undo') }}">
      <!-- empty SKU means “undo last scan” -->
      <input type="hidden" name="sku" value="">
      <button type="submit" class="btn btn-secondary">Undo Last Scan</button>
    </form>

    <form method="post" action="{{ url_for('checkout_clear') }}">
      <button type="submit" class="btn btn-secondary"
              onclick="return confirm('Clear entire checkout list?');">
        Clear Cart
      </button>
    </form>
  </div>

  <!-- CART TABLE -->
  <table class="checkout-table">
    <thead>
      <tr>
        <th>SKU</th>
        <th>Item</th>
        <th style="text-align:right;">Qty</th>
        <th style="text-align:right;">Price</th>
        <th style="text-align:right;">Line Total</th>
      </tr>
    </thead>
    <tbody>
      {% if cart_lines %}
        {% for line in cart_lines %}
          <tr>
            <td>{{ line.sku }}</td>
            <td>{{ line.item.title }}</td>
            <td style="text-align:right;">{{ line.qty }}</td>
            <td style="text-align:right;">${{ "%.2f"|format(line.price_dollars) }}</td>
            <td style="text-align:right;">${{ "%.2f"|format(line.line_total_dollars) }}</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="5">No items in cart. Scan something to begin.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>

  <!-- SUMMARY + DISCOUNT -->
  <div class="checkout-summary">
    <div class="summary-totals">
      <div><strong>Subtotal:</strong>
        ${{ "%.2f"|format(subtotal_dollars or 0) }}</div>
      <div><strong>Discount:</strong>
        -${{ "%.2f"|format(discount_dollars or 0) }}</div>
      <div><strong>Total Due:</strong>
        ${{ "%.2f"|format(total_dollars or 0) }}</div>
    </div>

    <form method="post"
          action="{{ url_for('checkout_discount') }}"
          class="discount-form">
      <label for="discount"><strong>Discount ($):</strong></label>
      <input id="discount"
             name="discount"
             type="number"
             step="0.01"
             min="0"
             value="{{ "%.2f"|format(discount_dollars or 0) }}">
      <button type="submit" class="btn btn-primary">Apply Discount</button>
    </form>
  </div>
</div>

<!-- SOUND EFFECTS -->
<audio id="beep-ok"
       src="{{ url_for('static', filename='checkout/beep-ok.mp3') }}"></audio>
<audio id="beep-error"
       src="{{ url_for('static', filename='checkout/beep-error.mp3') }}"></audio>
<audio id="beep-duplicate"
       src="{{ url_for('static', filename='checkout/beep-duplicate.mp3') }}"></audio>
<audio id="beep-undo"
       src="{{ url_for('static', filename='checkout/beep-undo.mp3') }}"></audio>

<script>
  // Play a sound based on what the server tells us
  window.addEventListener('DOMContentLoaded', function () {
    var el = document.getElementById('checkout-beep');
    if (!el) return;
    var beepType = el.dataset.beep || '';
    if (!beepType) return;

    var map = {
      'ok': 'beep-ok',
      'error': 'beep-error',
      'duplicate': 'beep-duplicate',
      'undo': 'beep-undo'
    };
    var audioId = map[beepType];
    if (!audioId) return;

    var audio = document.getElementById(audioId);
    if (audio) {
      try {
        audio.currentTime = 0;
        audio.play();
      } catch (e) {
        // browsers sometimes block autoplay, that's fine
      }
    }
  });
</script>

{% endblock %}
